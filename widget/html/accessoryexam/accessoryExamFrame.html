<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>辅助检查维护</title>
    <link rel="stylesheet" type="text/css" href="../../css/history.css" />
    <link rel="stylesheet" type="text/css" href="../../css/button.css" />
    <script type="text/javascript" src="../../script/api.js"></script>
    <script type="text/javascript" src="../../script/constants.js"></script>
    <script type="text/javascript" src="../../script/util.js"></script>
</head>

<body class="body-silver">
    <div class="flex-wrap flex-vertical">
        <header class="header-silver">
            <a id="left" tapmode="" onclick="window.closeWin();" class="button button-raised button-silver">
                &lt; 返回
            </a>
            <div id="middle">
                <span id="title">辅助检查维护</span>
            </div>
            <a id="right" tapmode="" onclick="saveAccessoryExam();" class="button button-raised button-blue">
                保存
            </a>
        </header>
        <div id="main" class="flex-con">
            <div class="groupName">干眼</div>
            <div class="group group-edit">
                <div class="field">
                    <div class="key">BUT. R</div>
                    <div class="value_with_unit">
                        <input type="text" id="but_r" />
                    </div>
                    <div class="unit">s</div>
                </div>
                <div class="field">
                    <div class="key">BUT. L</div>
                    <div class="value_with_unit">
                        <input type="text" id="but_l" />
                    </div>
                    <div class="unit">s</div>
                </div>
                <div class="field">
                    <div class="key">SIT. R</div>
                    <div class="value_with_unit_4">
                        <input type="text" id="sit_r" />
                    </div>
                    <div class="unit">mm&#47;5min</div>
                </div>
                <div class="field">
                    <div class="key">SIT. L</div>
                    <div class="value_with_unit_4">
                        <input type="text" id="sit_l" />
                    </div>
                    <div class="unit">mm&#47;5min</div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">前节照相</div>
                        <div class="img_button" id="qjzx_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="qjzx" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="qjzx_img"></div>
                </div>
            </div>
            <div class="groupName">白内障屈光</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">角膜曲率</div>
                        <div class="img_button" id="corneal_curvature_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="corneal_curvature" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="corneal_curvature_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">角膜地形图</div>
                        <div class="img_button" id="corneal_topography_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="corneal_topography" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="corneal_topography_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">IOL Master</div>
                        <div class="img_button" id="iol_master_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="iol_master" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="iol_master_img"></div>
                </div>
            </div>
            <div class="groupName">青光眼</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">UBM</div>
                        <div class="img_button" id="ubm_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="ubm" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="ubm_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">视野</div>
                        <div class="img_button" id="view_horizon_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="view_horizon" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="view_horizon_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">RFNL</div>
                        <div class="img_button" id="glaucoma_rnfl_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="glaucoma_rnfl" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="glaucoma_rnfl_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">MRI</div>
                        <div class="img_button" id="glaucoma_mri_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="glaucoma_mri" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="glaucoma_mri_img"></div>
                </div>
            </div>
            <div class="groupName">眼底</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">OCT</div>
                        <div class="img_button" id="oct_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="oct" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="oct_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">OCTA</div>
                        <div class="img_button" id="octa_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="octa" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="octa_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">眼底照相</div>
                        <div class="img_button" id="fundus_oculi_pic_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="fundus_oculi_pic" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="fundus_oculi_pic_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">B超</div>
                        <div class="img_button" id="b_ultrasonic_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="b_ultrasonic" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="b_ultrasonic_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">FFA</div>
                        <div class="img_button" id="ffa_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="ffa" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="ffa_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">ICG</div>
                        <div class="img_button" id="icg_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="icg" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="icg_img"></div>
                </div>
            </div>
            <div class="groupName">视神经眼科</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">VEP</div>
                        <div class="img_button" id="vep_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="vep" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="vep_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">ERG</div>
                        <div class="img_button" id="erg_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="erg" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="erg_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">RFNL</div>
                        <div class="img_button" id="no_rnfl_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="no_rnfl" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="no_rnfl_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">MRI</div>
                        <div class="img_button" id="no_mri_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="no_mri" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="no_mri_img"></div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
/**
 * [apiready description]
 * @return {[type]} [description]
 */
apiready = function() {
    window.closeWin = function(winName) {
        confirmChosen();
    }

    // 因为处理图片的时候需要暂时存储在本地，所以不能直接使用accessoryExam，否则取消修改无法实现
    // 所以在此页面首先取出accessoryExam存储为accessoryExamTmp，图片处理都使用accessoryExamTmp
    // 最后保存退出时再存储为accessoryExam
    var accessoryExamTmp = getStorage("accessoryExam");
    if (accessoryExamTmp != undefined) {
        setStorage("accessoryExamTmp", accessoryExamTmp);
    }
    setAccessoryExam(accessoryExamTmp);

    // 设置长按时间计时器
    timeOutEvent = 0;

}

function addImg(id) {
    var sourceType = "";
    var model = api.require('model');
    var localPath = "";
    model.config({
        appId: historyConstants.appId,
        appKey: historyConstants.appKey,
        host: historyConstants.host
    });
    api.confirm({
        title: '请选择',
        msg: '图片来源',
        buttons: ['拍照', '相册']
    }, function(ret, err) {
        if (ret) {
            if (ret.buttonIndex == 1) {
                sourceType = "camera";
            } else if (ret.buttonIndex == 2) {
                sourceType = "library";
            }
            api.getPicture({
                sourceType: sourceType,
                encodingType: 'jpg',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: false,
                quality: 90,
                // targetWidth: 100,
                targetHeight: 960,
                saveToPhotoAlbum: true
            }, function(ret, err) {
                if (ret) {
                    if (ret.data != "") {
                        showProgress("上传中...");
                        localPath = ret.data;
                        model.uploadFile({
                            report: true,
                            data: {
                                file: {
                                    url: localPath
                                },
                                // values: {
                                //     key1: id.replace("btn", "img")
                                // }
                            }
                        }, function(ret, err) {
                            if (ret) {
                                var state = ret.state;
                                if (state == 1) {
                                    var body = ret.body;
                                    if (body) {
                                        hideProgress();
                                        setImg(id.replace("btn", "img"), body.url);
                                    }
                                } else {
                                    // 可做进度条
                                }
                            } else {
                                alert(JSON.stringify(err))
                            }
                        });
                    }
                } else {
                    alert(JSON.stringify(err));
                }
            });
        } else {
            alert(JSON.stringify(err));
        }
    });
}

function setImg(imgGroup, url) {
    var accessoryExamTmp = getStorage("accessoryExamTmp");
    if (accessoryExamTmp == undefined) {
        accessoryExamTmp = {};
    }
    if (accessoryExamTmp[imgGroup] == undefined) {
        accessoryExamTmp[imgGroup] = [];
    }

    // 将本次新增的图片添加到图片组中
    accessoryExamTmp[imgGroup].push(url);
    // 将图片组转换成可显示的html代码
    var imgHtml = getImgHtml(accessoryExamTmp[imgGroup], imgGroup);
    $api.byId(imgGroup).innerHTML = imgHtml;

    setStorage("accessoryExamTmp", accessoryExamTmp);
}


function setImgs(data) {
    var idx = 0;
    while (idx < historyConstants.imgGroup.length) {
        var imgHtml = getImgHtml(data[historyConstants.imgGroup[idx]], historyConstants.imgGroup[idx]);
        $api.byId(historyConstants.imgGroup[idx]).innerHTML = imgHtml;
        idx = idx + 1;
    }
}

function getImgHtml(obj, imgGroup) {
    if (obj == undefined) {
        return "";
    }
    var size = obj.length;
    if (size == 0) {
        return "";
    }
    var idx = 0;
    var imgHtml = "";
    while (idx < size) {
        imgHtml = imgHtml + "<img src=" + obj[idx] + " id=" + imgGroup + idx +
            " onclick='openImg(this.id)' ontouchstart='confirmDeleteImg(this.id)' \
         ontouchmove='gtouchmove()' ontouchend='gtouchend()' />";
        idx = idx + 1;
    }
    return imgHtml;
}

function openImg(imgId) {
    var imgGroup = imgId.substr(0, imgId.length - 1);
    var id = imgId.substr(-1);
    var accessoryExamTmp = getStorage("accessoryExamTmp");
    var photoBrowser = api.require('photoBrowser');
    photoBrowser.open({
        images: accessoryExamTmp[imgGroup],
        activeIndex: id,
        // placeholderImg: 'widget://res/img/apicloud.png',
        bgColor: '#000'
    }, function(ret) {
        if (ret.eventType == "click") {
            photoBrowser.close();
        }
    });
}

function confirmDeleteImg(id) {
    timeOutEvent = setTimeout(function() {
        timeOutEvent = 0;
        api.confirm({
            title: '请选择',
            msg: '删除图片？',
            buttons: ['删除', '取消']
        }, function(ret, err) {
            if (ret) {
                if (ret.buttonIndex == 1) {
                    var imgGroup = id.substr(0, id.length - 1);
                    var imgId = id.substr(-1);
                    var accessoryExamTmp = getStorage("accessoryExamTmp");
                    accessoryExamTmp[imgGroup].splice(imgId, 1);
                    setStorage("accessoryExamTmp", accessoryExamTmp);
                    setImgs(accessoryExamTmp);
                }
            } else {
                alert(JSON.stringify(err));
            }
        });

    }, 600);
    return false;
}

function gtouchend() {
    clearTimeout(timeOutEvent); //清除定时器
    if (timeOutEvent != 0) {
        //这里写要执行的内容（尤如onclick事件）
        // alert("你这是点击，不是长按");
    }
    return false;
};
//如果手指有移动，则取消所有事件，此时说明用户只是要移动而不是长按
function gtouchmove() {
    clearTimeout(timeOutEvent); //清除定时器
    timeOutEvent = 0;
};

function saveAccessoryExam() {
    var id = "";
    var accessoryExamTmp = getStorage("accessoryExamTmp");
    if (accessoryExamTmp == undefined) {
        accessoryExamTmp = {};
    }
    if (accessoryExamTmp.id != undefined) {
        id = accessoryExamTmp.id;
    }
    accessoryExamTmp.source_id = api.pageParam.source_id;
    accessoryExamTmp.but_r = $api.byId("but_r").value;
    accessoryExamTmp.but_l = $api.byId("but_l").value;
    accessoryExamTmp.sit_r = $api.byId("sit_r").value;
    accessoryExamTmp.sit_l = $api.byId("sit_l").value;
    accessoryExamTmp.qjzx = $api.byId("qjzx").value;
    accessoryExamTmp.corneal_curvature = $api.byId("corneal_curvature").value;
    accessoryExamTmp.corneal_topography = $api.byId("corneal_topography").value;
    accessoryExamTmp.iol_master = $api.byId("iol_master").value;
    accessoryExamTmp.ubm = $api.byId("ubm").value;
    accessoryExamTmp.view_horizon = $api.byId("view_horizon").value;
    accessoryExamTmp.glaucoma_rnfl = $api.byId("glaucoma_rnfl").value;
    accessoryExamTmp.glaucoma_mri = $api.byId("glaucoma_mri").value;
    accessoryExamTmp.oct = $api.byId("oct").value;
    accessoryExamTmp.octa = $api.byId("octa").value;
    accessoryExamTmp.fundus_oculi_pic = $api.byId("fundus_oculi_pic").value;
    accessoryExamTmp.b_ultrasonic = $api.byId("b_ultrasonic").value;
    accessoryExamTmp.ffa = $api.byId("ffa").value;
    accessoryExamTmp.icg = $api.byId("icg").value;
    accessoryExamTmp.vep = $api.byId("vep").value;
    accessoryExamTmp.erg = $api.byId("erg").value;
    accessoryExamTmp.no_rnfl = $api.byId("no_rnfl").value;
    accessoryExamTmp.no_mri = $api.byId("no_mri").value;
    var model = api.require('model');
    model.config({
        appId: historyConstants.appId,
        appKey: historyConstants.appKey,
        host: historyConstants.host
    });
    if (id != "" && id != undefined) {
        model.updateById({
            class: historyConstants.table.accessoryExam,
            id: id,
            value: accessoryExamTmp
        }, function(ret, err) {
            if (ret) {
                setStorage("accessoryExam", ret);
                rmStorage("accessoryExamTmp");
                accessoryExamSaveEvent(ret.id);
                api.closeWin();
            } else {
                alert(JSON.stringify(err));
            }
        });
    } else {
        model.insert({
            class: historyConstants.table.accessoryExam,
            value: accessoryExamTmp
        }, function(ret, err) {
            if (ret) {
                setStorage("accessoryExam", ret);
                rmStorage("accessoryExamTmp");
                accessoryExamSaveEvent(ret.id);
                api.closeWin();
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
}
</script>

</html>
