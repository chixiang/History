<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>辅助检查维护</title>
    <link rel="stylesheet" type="text/css" href="../../css/history.css" />
    <link rel="stylesheet" type="text/css" href="../../css/button.css" />
    <script type="text/javascript" src="../../script/api.js"></script>
    <script type="text/javascript" src="../../script/constants.js"></script>
    <script type="text/javascript" src="../../script/util.js"></script>
</head>

<body class="body-silver">
    <div class="flex-wrap flex-vertical">
        <header class="header-silver">
            <a id="left" tapmode="" onclick="window.closeWin();" class="button button-raised button-silver">
                &lt; 返回
            </a>
            <div id="middle">
                <span id="title">辅助检查维护</span>
            </div>
            <a id="right" tapmode="" onclick="saveAccessoryExam();" class="button button-raised button-blue">
                保存
            </a>
        </header>
        <div id="main" class="flex-con">
            <div class="groupName">干眼</div>
            <div class="group group-edit">
                <div class="field">
                    <div class="key">BUT. R</div>
                    <div class="value_with_unit">
                        <input type="text" id="but_r" />
                    </div>
                    <div class="unit">s</div>
                </div>
                <div class="field">
                    <div class="key">BUT. L</div>
                    <div class="value_with_unit">
                        <input type="text" id="but_l" />
                    </div>
                    <div class="unit">s</div>
                </div>
                <div class="field">
                    <div class="key">SIT. R</div>
                    <div class="value_with_unit_4">
                        <input type="text" id="sit_r" />
                    </div>
                    <div class="unit">mm&#47;5min</div>
                </div>
                <div class="field">
                    <div class="key">SIT. L</div>
                    <div class="value_with_unit_4">
                        <input type="text" id="sit_l" />
                    </div>
                    <div class="unit">mm&#47;5min</div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">前节照相</div>
                        <div class="img_button" id="qjzx_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="qjzx" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="qjzx_img"></div>
                </div>
            </div>
            <div class="groupName">白内障屈光</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">角膜曲率</div>
                        <div class="img_button" id="corneal_curvature_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="corneal_curvature" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="corneal_curvature_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">角膜地形图</div>
                        <div class="img_button" id="corneal_topography_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="corneal_topography" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="corneal_topography_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">IOL Master</div>
                        <div class="img_button" id="iol_master_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="iol_master" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="iol_master_img"></div>
                </div>
            </div>
            <div class="groupName">青光眼</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">UBM</div>
                        <div class="img_button" id="ubm_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="ubm" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="ubm_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">视野</div>
                        <div class="img_button" id="view_horizon_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="view_horizon" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="view_horizon_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">RFNL</div>
                        <div class="img_button" id="glaucoma_rnfl_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="glaucoma_rnfl" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="glaucoma_rnfl_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">MRI</div>
                        <div class="img_button" id="glaucoma_mri_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="glaucoma_mri" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="glaucoma_mri_img"></div>
                </div>
            </div>
            <div class="groupName">眼底</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">OCT</div>
                        <div class="img_button" id="oct_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="oct" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="oct_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">OCTA</div>
                        <div class="img_button" id="octa_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="octa" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="octa_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">眼底照相</div>
                        <div class="img_button" id="fundus_oculi_pic_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="fundus_oculi_pic" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="fundus_oculi_pic_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">B超</div>
                        <div class="img_button" id="b_ultrasonic_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="b_ultrasonic" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="b_ultrasonic_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">FFA</div>
                        <div class="img_button" id="ffa_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="ffa" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="ffa_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">ICG</div>
                        <div class="img_button" id="icg_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="icg" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="icg_img"></div>
                </div>
            </div>
            <div class="groupName">视神经眼科</div>
            <div class="group group-edit">
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">VEP</div>
                        <div class="img_button" id="vep_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="vep" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="vep_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">ERG</div>
                        <div class="img_button" id="erg_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="erg" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="erg_img"></div>
                </div>
                <div class="field textarea_field">
                    <div class="field_img">
                        <div class="textarea_key_with_img">RFNL</div>
                        <div class="img_button" id="no_rnfl_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="no_rnfl" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="no_rnfl_img"></div>
                </div>
                <div class="field textarea_field bottom">
                    <div class="field_img">
                        <div class="textarea_key_with_img">MRI</div>
                        <div class="img_button" id="no_mri_btn" onclick="addImg(this.id)"><img src="../../image/insertImg.png" /></div>
                    </div>
                    <div class="textarea_value">
                        <textarea type="text" id="no_mri" placeholder="请输入内容"></textarea>
                    </div>
                    <div class="accessory_img" id="no_mri_img"></div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
/**
 * [apiready description]
 * @return {[type]} [description]
 */
apiready = function() {
    window.closeWin = function(winName) {
        api.confirm({
            title: '请选择',
            msg: '未确认的修改会丢失，是否确认退出？',
            buttons: ['退出', '取消']
        }, function(ret, err) {
            if (ret) {
                if (ret.buttonIndex == 1) {
                    api.closeWin();
                }
            } else {
                alert(JSON.stringify(err));
            }
        });
    }

    accessoryExam = {};
    var accessoryExamTmp = getStorage("accessoryExam");
    setAccessoryExam(accessoryExamTmp);

    // 绑定android后退键事件
    api.addEventListener({
        name: 'keyback'
    }, function(ret, err) {
        if (ret) {
            api.confirm({
                title: '请选择',
                msg: '未确认的修改会丢失，是否确认退出？',
                buttons: ['退出', '取消']
            }, function(ret, err) {
                if (ret) {
                    if (ret.buttonIndex == 1) {
                        api.closeWin();
                    }
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }
    });
}

function addImg(id) {
    var sourceType = "";
    var model = api.require('model');
    var localPath = "";
    model.config({
        appId: historyConstants.appId,
        appKey: historyConstants.appKey,
        host: historyConstants.host
    });
    api.confirm({
        title: '请选择',
        msg: '图片来源',
        buttons: ['拍照', '相册']
    }, function(ret, err) {
        if (ret) {
            if (ret.buttonIndex == 1) {
                sourceType = "camera";
            } else if (ret.buttonIndex == 2) {
                sourceType = "library";
            }
            api.getPicture({
                sourceType: sourceType,
                encodingType: 'jpg',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: false,
                quality: 90,
                // targetWidth: 100,
                targetHeight: 960,
                saveToPhotoAlbum: false
            }, function(ret, err) {
                if (ret) {
                    if (ret.data != "") {
                        showProgress("上传中...");
                        localPath = ret.data;
                        model.uploadFile({
                            report: true,
                            data: {
                                file: {
                                    url: localPath
                                },
                                // values: {
                                //     key1: id.replace("btn", "img")
                                // }
                            }
                        }, function(ret, err) {
                            if (ret) {
                                var state = ret.state;
                                if (state == 1) {
                                    var body = ret.body;
                                    if (body) {
                                        hideProgress();
                                        setImg(id.replace("btn", "img"), body.url);
                                    }
                                } else {
                                    // 可做进度条
                                }
                            } else {
                                alert(JSON.stringify(err))
                            }
                        });
                    }
                } else {
                    alert(JSON.stringify(err));
                }
            });
        } else {
            alert(JSON.stringify(err));
        }
    });
}

function setImg(id, url) {
    var imgType = id.replace('btn', 'img');
    var imgStrs = {};
    var imgStr = "";

    // 获取已添加的图片
    // var accessoryExam = getStorage("accessoryExamTmp");
    // 第一次添加某栏位图片，需初始化
    if (accessoryExam[imgType] == undefined) {
        accessoryExam[imgType] = {};
    }
    imgStrs = accessoryExam[imgType];
    // 按数字累加图片的key值，value为图片url
    var imgId = JSONLength(imgStrs) + 1;
    imgStrs[imgId] = url;

    // 将图片组转换成可显示的html代码
    var imgHtml = getImgHtml(imgStrs);
    $api.byId(id).innerHTML = imgHtml;

    // setStorage("accessoryExam", accessoryExamTmp);
}

function saveAccessoryExam() {
    var id = "";
    var accessoryExamTmp = getStorage("accessoryExam");
    if (accessoryExamTmp != undefined) {
        id = accessoryExamTmp.id;
    }
    accessoryExam.source_id = api.pageParam.source_id;
    accessoryExam.but_r = $api.byId("but_r").value;
    accessoryExam.but_l = $api.byId("but_l").value;
    accessoryExam.sit_r = $api.byId("sit_r").value;
    accessoryExam.sit_l = $api.byId("sit_l").value;
    accessoryExam.qjzx = $api.byId("qjzx").value;
    accessoryExam.corneal_curvature = $api.byId("corneal_curvature").value;
    accessoryExam.corneal_topography = $api.byId("corneal_topography").value;
    accessoryExam.iol_master = $api.byId("iol_master").value;
    accessoryExam.ubm = $api.byId("ubm").value;
    accessoryExam.view_horizon = $api.byId("view_horizon").value;
    accessoryExam.glaucoma_rnfl = $api.byId("glaucoma_rnfl").value;
    accessoryExam.glaucoma_mri = $api.byId("glaucoma_mri").value;
    accessoryExam.oct = $api.byId("oct").value;
    accessoryExam.octa = $api.byId("octa").value;
    accessoryExam.fundus_oculi_pic = $api.byId("fundus_oculi_pic").value;
    accessoryExam.b_ultrasonic = $api.byId("b_ultrasonic").value;
    accessoryExam.ffa = $api.byId("ffa").value;
    accessoryExam.icg = $api.byId("icg").value;
    accessoryExam.vep = $api.byId("vep").value;
    accessoryExam.erg = $api.byId("erg").value;
    accessoryExam.no_rnfl = $api.byId("no_rnfl").value;
    accessoryExam.no_mri = $api.byId("no_mri").value;
    var model = api.require('model');
    model.config({
        appId: historyConstants.appId,
        appKey: historyConstants.appKey,
        host: historyConstants.host
    });
    model.updateById({
        class: historyConstants.table.accessoryExam,
        id: id,
        value: accessoryExam
    }, function(ret, err) {
        if (ret) {
            setStorage("accessoryExam", ret);
            accessoryExamSaveEvent(ret.id);
            api.closeWin();
        } else {
            alert(JSON.stringify(ret));
        }
    });
}

</script>

</html>
